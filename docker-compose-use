#!/bin/env bash
# Run this preprocessor when the configuration changes to
# regenerate the .env file for docker-compose
# 
# Parameter 1 : The source *.env file (comments and blank lines allowed)
# Parameter 2 : The output file (default .env) - for testing

# Find where we we are, to configure THIS docker-compose folder
thisScript=$(readlink -f "${BASH_SOURCE[0]}")
thisDir="${thisScript%/*}"

# Set the default .env file that docker-compose uses
out=${2:-.env}

# A random tmp-file suffix
rand=$RANDOM

# Step 1. Lines with a single '# ' are removed completely)
# This allows commenting to work within a series of \ separated lines
# not conventional, but more readable
## lines will survive this filter.

grep -vE "^#( |$)" $1 > /tmp/${out}${rand}

# Step 2. Whitespace is trimmed (in place)
sed -iE 's/^ *//;s/ *$//' /tmp/${out}${rand}

# Step 4. Remove Empty lines
grep . /tmp/${out}${rand} > /tmp/${out}${rand}1

# Step 3. Lines ending in \ are concatenated
awk '{if (sub(/\\$/,"")) printf "%s", $0; else print $0}' /tmp/${out}${rand}1 > "${thisDir}/${out}"
 
echo "Set $thisDir/${out}" 2>&1
